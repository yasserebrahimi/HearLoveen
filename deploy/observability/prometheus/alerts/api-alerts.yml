groups:
- name: api_alerts
  interval: 30s
  rules:
  # High Error Rate
  - alert: HighErrorRate
    expr: |
      sum(rate(http_requests_total{status=~"5.."}[5m])) by (service)
      /
      sum(rate(http_requests_total[5m])) by (service)
      > 0.05
    for: 5m
    labels:
      severity: critical
      component: api
    annotations:
      summary: "High error rate on {{ $labels.service }}"
      description: "Service {{ $labels.service }} has error rate above 5% (current: {{ $value | humanizePercentage }})"

  # High Response Time
  - alert: HighResponseTime
    expr: |
      histogram_quantile(0.95,
        sum(rate(http_request_duration_seconds_bucket[5m])) by (service, le)
      ) > 1.0
    for: 5m
    labels:
      severity: warning
      component: api
    annotations:
      summary: "High response time on {{ $labels.service }}"
      description: "95th percentile response time is {{ $value }}s (threshold: 1s)"

  # API Service Down
  - alert: APIServiceDown
    expr: up{job="api"} == 0
    for: 2m
    labels:
      severity: critical
      component: api
    annotations:
      summary: "API service {{ $labels.instance }} is down"
      description: "API service has been down for more than 2 minutes"

  # High Request Rate
  - alert: HighRequestRate
    expr: |
      sum(rate(http_requests_total[1m])) by (service) > 1000
    for: 5m
    labels:
      severity: warning
      component: api
    annotations:
      summary: "High request rate on {{ $labels.service }}"
      description: "Request rate is {{ $value }} req/s (threshold: 1000 req/s)"

  # Database Connection Pool Exhausted
  - alert: DatabaseConnectionPoolExhausted
    expr: |
      npgsql_connection_pool_used_connections / npgsql_connection_pool_max_connections > 0.9
    for: 2m
    labels:
      severity: warning
      component: database
    annotations:
      summary: "Database connection pool nearly exhausted"
      description: "Connection pool usage is at {{ $value | humanizePercentage }}"

  # Memory Usage High
  - alert: HighMemoryUsage
    expr: |
      process_working_set_bytes / process_private_memory_limit_bytes > 0.85
    for: 5m
    labels:
      severity: warning
      component: api
    annotations:
      summary: "High memory usage on {{ $labels.instance }}"
      description: "Memory usage is at {{ $value | humanizePercentage }}"

  # CPU Usage High
  - alert: HighCPUUsage
    expr: |
      rate(process_cpu_seconds_total[5m]) > 0.8
    for: 10m
    labels:
      severity: warning
      component: api
    annotations:
      summary: "High CPU usage on {{ $labels.instance }}"
      description: "CPU usage is {{ $value | humanizePercentage }}"
